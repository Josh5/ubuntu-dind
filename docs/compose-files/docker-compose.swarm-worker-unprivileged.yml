# ---------------
# Docker Swarm Worker (Unprivileged)
#
# ---------------
# Config (paste into portainer advance env text input):
#
#   #@ Host Config
#   #-  - HOST_HOSTNAME -
#   #-    The host's hostname.
#   HOST_HOSTNAME=Server
#   #-  - HOST_CONTAINERNAME -
#   #-    Container name for this worker.
#   HOST_CONTAINERNAME=dind-swarm-worker-unprivileged
#   #-  - HOST_OS -
#   #-    The host OS name.
#   HOST_OS=Unraid
#   #-  - TZ -
#   #-    The timezone.
#   TZ=Etc/UTC
#
#   #@ Network Config
#   #-  - DIND_SUBNET -
#   #-    Docker network subnet (CIDR).
#   DIND_SUBNET=192.168.1.0/24
#   #-  - DIND_IP_ADDRESS -
#   #-    The container IPv4 address.
#   DIND_IP_ADDRESS=192.168.1.202
#
#   #@ Resource Limits
#   #-  - DEFAULT_CPUSET -
#   #-    Limit the CPUs available to the container.
#   DEFAULT_CPUSET=0-3
#   #-  - DEFAULT_CPUSHARES -
#   #-    Relative CPU share weight.
#   DEFAULT_CPUSHARES=1024
#   #-  - DEFAULT_MEMLIMIT -
#   #-    Limit each running container's memory to this.
#   DEFAULT_MEMLIMIT=256m
#   #-  - DEFAULT_MEMRESERVATION -
#   #-    Memory soft reservation.
#   DEFAULT_MEMRESERVATION=128m
#   #-  - DEFAULT_SHMSIZE -
#   #-    /dev/shm size.
#   DEFAULT_SHMSIZE=64m
#
#   #@ Container Config
#   #-  - CONFIG_PATH -
#   CONFIG_PATH=/mnt/user/system/dind-swarm-worker/etc
#   #-  - CERTS_PATH -
#   CERTS_PATH=/mnt/user/system/dind-swarm-worker/certs
#   #-  - DATA_PATH -
#   DATA_PATH=/var/lib/docker/dind-var/dind-swarm-worker
#   #-  - DOCKER_FORCE_INSECURE_TCP -
#   #-    Expose tcp://0.0.0.0:2375 even when TLS is enabled on 2376.
#   DOCKER_FORCE_INSECURE_TCP=false
#
# ---------------
---
networks:
  eth0:
    driver: bridge
    ipam:
      config:
        - subnet: ${DIND_SUBNET:-192.168.1.0/24}

services:
  dind-swarm-worker:
    image: ghcr.io/josh5/ubuntu-dind:latest
    restart: unless-stopped
    ipc: private
    pids_limit: 2048

    # RESOURCES:
    cpuset: ${DEFAULT_CPUSET:-}
    cpu_shares: ${DEFAULT_CPUSHARES:-1024}
    mem_limit: ${DEFAULT_MEMLIMIT:-0}
    mem_reservation: ${DEFAULT_MEMRESERVATION:-0}
    shm_size: ${DEFAULT_SHMSIZE:-}

    # UNPRIVILEGED MODE:
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
      - SYS_NICE
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    # NETWORK:
    networks:
      eth0:
        ipv4_address: ${DIND_IP_ADDRESS:?}
    hostname: ${HOST_HOSTNAME:?}
    extra_hosts:
      - '${HOST_HOSTNAME:?}:127.0.0.1'

    labels:
      - net.unraid.docker.managed=dockerman
      - net.unraid.docker.icon=https://raw.githubusercontent.com/docker-library/docs/471fa6e4cb58062ccbf91afc111980f9c7004981/swarm/logo.png

    # ENVIRONMENT:
    environment:
      TZ: ${TZ}
      HOST_OS: ${HOST_OS}
      HOST_HOSTNAME: ${HOST_HOSTNAME:?}
      HOST_CONTAINERNAME: ${HOST_CONTAINERNAME:?}
      DOCKER_TLS_CERTDIR: /certs
      DOCKER_FORCE_INSECURE_TCP: ${DOCKER_FORCE_INSECURE_TCP:-false}

    # VOLUMES:
    volumes:
      # Container config
      - type: bind
        source: ${CERTS_PATH}
        target: /certs
      - type: bind
        source: ${CONFIG_PATH}
        target: /etc/docker

      # Docker data directory
      - type: bind
        source: ${DATA_PATH}
        target: /var/lib/docker

      # Add any mounts from the host here
      - type: bind
        source: /mnt
        target: /mnt
